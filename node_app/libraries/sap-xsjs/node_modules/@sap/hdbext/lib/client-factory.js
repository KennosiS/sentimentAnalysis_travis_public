'use strict';

var assert = require('assert');
var _ = require('lodash');
var hdb = require('hdb');
var clientSession = require('./client-session');
var logger = require('./utils/logger').getLogger();

module.exports.createConnection = createConnection;


function createConnection(options, callback) {
  options = normalizeOptions(options);

  var client = hdb.createClient(options);
  client.on('error', function (err) {
    logger.warn('Network connection error', err);
  });
  client.connect(function (err) {
    if (err) {
      return callback(err);
    }
    clientSession.updateConnectionOptions(client, options, function(err) {
      if (err) {
        client.close();
        client = null;
      }
      callback(err, client);
    });
  });
}

function normalizeOptions(options) {
  options = _.clone(options);

  if (!options.hosts && options.db_hosts) {
    assert(Array.isArray(options.db_hosts), 'options.db_hosts should be an array');
    options.hosts = options.db_hosts;
    delete options.db_hosts;
  }

  if (!options.ca && options.certificate) {
    options.ca = [options.certificate];
    delete options.certificate;
  }

  return options;
}
