'use strict';

//Include
var sql = require('./sqlStatement');
var linksSQL = require ("./createLinksSQLStatements");

exports.createPutPostLinksStatements = function (context, asyncDone) {
	linksSQL.createLinksStatements(context);
	return asyncDone(null, context);
};

/******************** MxN relationships ***********************/

exports.createPutPostLinksMNStatements = function (context, asyncDone) {
    try {
        var dbSegLast = context.oData.dbSegmentLast,
	        sqlContext = linksSQL.createMNSQLContext(context, dbSegLast);

        context.sql = sqlContext;
        dbSegLast.sql.stmContainer = new sql.PostContainer();

        createMNPutPostLinksStatementContainer(sqlContext);
        return asyncDone(null, context);
    } catch (err) {
        return asyncDone(err, context);
    }
};

function createMNPutPostLinksStatementContainer(sqlContext) {
    var dbSeg = sqlContext.dbSegLast;

	linksSQL.createMNStatementContainer(sqlContext);

    //create insert statement for master table
    dbSeg.sql.stmContainer.insertTmp = masterMNTableInsertTmp(sqlContext, dbSeg.sql.rId);

    //create insert statement for master table
    dbSeg.sql.stmContainer.insertReal = masterMNTableInsert(sqlContext, dbSeg.sql.rId);
}

function masterMNTableInsertTmp(sqlContext, rId) {
    sqlContext.context.logger.debug('createPutPostLinksStatements', 'masterMNTableInsertTmp');
    var dbSeg = sqlContext.dbSegLast;

    var stm = new sql.Insert();
    stm.setTableName({table: rId});
    //SELECT
    stm.addNames(dbSeg.getOverPropertiesForSelect(rId));

    return stm;
}

function masterMNTableInsert(sqlContext, rId) {
    var dbSeg = sqlContext.dbSegLast;

    //subselect
    var subSelect = new sql.Select();
    subSelect.addSelects(new sql.Formula(null, '*'));
    subSelect.setFrom({schema: null, table: rId, alias: null});

    var stm = new sql.Upsert();

    stm.setTable({table: dbSeg.getOver().object});
    stm.addNames(dbSeg.getOverPropertiesForSelect(rId));

    //Values
    stm.setSubSelect(subSelect);

    return stm;
}
